<!doctype html>
<html>
    <head>
    <title>test</title>
        <script src="main.js"></script>
        <link rel="stylesheet" type="text/css" href="main.css">
        <script src="jquery-3.2.1.js"></script>
    </head>
    <body onkeydown="keyPressDown(event)" onkeyup="keyPressUp(event)">
        
        <!-- <canvas id="gameWindow" class="gameWindow"></canvas> -->
        
        <div class="debug" id="debug"></div>
        <div id="box" class="box"></div>
        <div id="box2" class="box2"></div>
        <div id="box3" class="box3"></div>
        <div id="box4" class="box4"></div>
        <div id="boxleft" class="boxright"></div>
        <div id="boxright" class="boxright"></div>
        <script>
            //canvas = $("#gameWindow");
            //var context = canvas.getContext(2d);
            //var xMax = canvas.width;
            //var yMax = canvas.height;
            
            //physics variables
            var gravity = .7;
            var windResistance = .08;
            var terminalVelocity = -20  ;
            
            //TODO: create objects in external object file.
            //      load dynamic world
            
            //player object
            var player = new Object();
            player.myID = box;
            player.xspeed = 0;
            player.yspeed = 0;
            player.xpos = 300;
            player.ypos = 500;
            player.xBox = 70;
            player.yBox = 92;
            player.animFrame = 0;
            player.jumpStrength = 20;
            player.airborne = true;
            player.moveSpeed = 1;
            player.walk = [[0, 0], [71, 0], [142, 0], [0, 95], [71, 95], [142, 95], [213, 0], [284, 0], [213, 95], [355, 0], [284, 95]];
            
            //ground object
            var blocky = new Object();
            blocky.myID = box2;
            blocky.xpos = 0;
            blocky.ypos = 0;
            blocky.xBox = 5000;
            blocky.yBox = 70;
            blocky.friction = .5;
            blocky.collide = function(target) {
                //ground collision 
                if (target.ypos+1 >= this.ypos + this.yBox) {
                    target.yspeed = 0;
                    target.airborne = false;
                    if (target.xspeed >= this.friction)
                        target.xspeed -= this.friction;
                    else if (target.xspeed <= -1 * this.friction)
                        target.xspeed += this.friction;
                    else 
                        target.xspeed = 0;
                }    
                //update debug menu
                updateDebug();
            }
            
            //ice object
            var blocky2 = new Object();
            blocky2.myID = box3;
            blocky2.xpos = 500;
            blocky2.ypos = 70;
            blocky2.xBox = 500;
            blocky2.yBox = 70;
            blocky2.friction = .03;
            blocky2.collide = function(target) {
                //ground collision 
                if (target.ypos+1 >= this.ypos + this.yBox) {
                    target.yspeed = 0;
                    target.airborne = false;
                    if (target.xspeed >= this.friction)
                        target.xspeed -= this.friction;
                    else if (target.xspeed <= -1 * this.friction)
                        target.xspeed += this.friction;
                    else 
                        target.xspeed = 0;
                }    
                //update debug menu
                updateDebug();
            }
            
            //floating block
            var blocky3 = new Object();
            blocky3.myID = box4;
            blocky3.xpos = 1200;
            blocky3.ypos = 300;
            blocky3.xBox = 300;
            blocky3.yBox = 70;
            blocky3.friction = .5;
            blocky3.collide = function(target) {
                //ground collision 
                if (target.ypos+1 >= this.ypos + this.yBox) {
                    target.yspeed = 0;
                    target.airborne = false;
                    if (target.xspeed >= this.friction)
                        target.xspeed -= this.friction;
                    else if (target.xspeed <= -1 * this.friction)
                        target.xspeed += this.friction;
                    else 
                        target.xspeed = 0;
                }    
                //update debug menu
                updateDebug();
            }
            
            //left boundry
            var blockLeft = new Object();
            blockLeft.myID = boxleft;
            blockLeft.xpos = 0;
            blockLeft.ypos = 0;
            blockLeft.xBox = 2;
            blockLeft.yBox = 5000;
            blockLeft.collide = function(target) {};
            
            //right boundry
            var blockRight = new Object();
            blockRight.myID = boxright;
            blockRight.xpos = 5000;
            blockRight.ypos = 0;
            blockRight.xBox = 2;
            blockRight.yBox = 5000;
            blockRight.collide = function(target) {};
            
            //array of objects
            var objects = [];
            objects.push(blocky);
            objects.push(blocky2);
            objects.push(blocky3);
            objects.push(blockLeft);
            objects.push(blockRight);
            
            var rightDown = false;
            var leftDown = false;
            var upDown = false;
            var downDown = false;
            
            function updateDebug() {
                $("#debug")[0].innerHTML="xpos: " + player.xpos + " | ypos: " + player.ypos + " | xspeed: " + player.xspeed.toFixed(2) + " | yspeed: " + player.yspeed.toFixed(2) + " ";
            }
            
            function keyPressDown(key) {
                var thisKey = key.keyCode? key.keyCode : key.charCode;
                switch(thisKey) {
                    case 65: 
                        leftDown = true;
                        break;
                    case 68:
                        rightDown = true;
                        break;
                    case 87:
                        upDown = true;
                        break;
                    case 83:
                        downDown = true;
                        break;
                }
            }
            
            function keyPressUp(key) {
                var thisKey = key.keyCode? key.keyCode : key.charCode;
                switch(thisKey) {
                    case 65: 
                        leftDown = false;
                        break;
                    case 68:
                        rightDown = false;
                        break;
                    case 87:
                        upDown = false;
                        break;
                    case 83:
                        downDown = false;
                        break;
                }
            } 
            
            function checkCollision(obj1, obj2) {
                    //top left corner
                        if (obj1.xpos > obj2.xpos && 
                            obj1.xpos < obj2.xpos+obj2.xBox && 
                            obj1.ypos+obj1.yBox > obj2.ypos && 
                            obj1.ypos+obj1.yBox < obj2.ypos+obj2.yBox) {
                                obj2.collide(obj1);
                                return false;
                        }
                    //top right corner
                        if (obj1.xpos+obj1.xBox > obj2.xpos && 
                            obj1.xpos+obj1.xBox < obj2.xpos+obj2.xBox && 
                            obj1.ypos+obj1.yBox > obj2.ypos && 
                            obj1.ypos+obj1.yBox < obj2.ypos+obj2.yBox) {
                                obj2.collide(obj1);
                            return false;
                        }
                    //bottom left corner
                        
                        if (obj1.xpos > obj2.xpos && 
                            obj1.xpos < obj2.xpos+obj2.xBox && 
                            obj1.ypos > obj2.ypos && 
                            obj1.ypos < obj2.ypos+obj2.yBox) {
                                obj2.collide(obj1);
                            return false;
                        }
                    //bottom right 
                        if (obj1.xpos+obj1.xBox > obj2.xpos && 
                            obj1.xpos+obj1.xBox < obj2.xpos+obj2.xBox && 
                            obj1.ypos > obj2.ypos && 
                            obj1.ypos < obj2.ypos+obj2.yBox) {
                                obj2.collide(obj1);
                            return false;
                        }
                
                    //top left corner
                        if (obj2.xpos > obj1.xpos && 
                            obj2.xpos < obj1.xpos+obj1.xBox && 
                            obj2.ypos+obj2.yBox > obj1.ypos && 
                            obj2.ypos+obj2.yBox < obj1.ypos+obj1.yBox) {
                                return false;
                        }
                    //top right corner
                        if (obj2.xpos+obj2.xBox > obj1.xpos && 
                            obj2.xpos+obj2.xBox < obj1.xpos+obj1.xBox && 
                            obj2.ypos+obj2.yBox > obj1.ypos && 
                            obj2.ypos+obj2.yBox < obj1.ypos+obj1.yBox) {
                            return false;
                        }
                    //bottom left corner

                        if (obj2.xpos > obj1.xpos && 
                            obj2.xpos < obj1.xpos+obj1.xBox && 
                            obj2.ypos > obj1.ypos && 
                            obj2.ypos < obj1.ypos+obj1.yBox) {
                            return false;
                        }
                    //bottom right 
                        if (obj2.xpos+obj2.xBox > obj1.xpos && 
                            obj2.xpos+obj2.xBox < obj1.xpos+obj1.xBox && 
                            obj2.ypos > obj1.ypos && 
                            obj2.ypos < obj1.ypos+obj1.yBox) {
                            return false;
                        }
                return true;
            }
            
            //main running event - 60fps
            setInterval(function() { 
                
                
                //gravity
                if (player.yspeed > terminalVelocity)
                    player.yspeed -= gravity;
                //wind resistance
                if (player.xspeed >= windResistance)
                    player.xspeed -= windResistance;
                else if (player.xspeed <= -1 * windResistance)
                    player.xspeed += windResistance;
                else 
                    player.xspeed = 0;
                
                if (rightDown) {
                    if (player.xspeed < 10)
                        player.xspeed += player.moveSpeed;
                }
                if (leftDown) {
                    if (player.xspeed > -10)
                        player.xspeed -= player.moveSpeed;
                }
                if (upDown) {
                    if (player.airborne == false) {
                        player.yspeed += player.jumpStrength;
                        player.airborne = true;
                    }
                }
                if (downDown) {
                    //nothing here yet
                }
                
                if (player.yspeed != 0) {
                    player.airborne = true;
                }
                
                //horizontal movement
                for (i = 0; i < Math.abs(player.xspeed); i++) {
                    if (player.xspeed > 0) {
                        
                        var collisions = 0;
                        player.xpos++;
                        
                        var returnedObjects = objects.filter(   function(obj) {
                                                                return  obj.xpos < player.xpos + player.xBox;
                                                            });
                        //array of all objects with x values that could potentially collide
                        returnedObjects.forEach(function(object) {
                            if (!checkCollision(player, object)) {
                                collisions++;
                            }
                        });
                        
                        if (collisions > 0) {
                            player.xpos--;
                            break;
                        } else {
                            $("#box")[0].style.left = player.xpos + "px";
                        }
                        
                        //update debug menu
                        updateDebug();
                    } else if (player.xspeed < 0) {
                        
                        var collisions = 0;
                        player.xpos--;
                        
                        var returnedObjects = objects.filter(   function(obj) {
                                                                return  obj.xpos+obj.xBox > player.xpos;
                                                            });
                        //array of all objects with x values that could potentially collide
                        returnedObjects.forEach(function(object) {
                            if (!checkCollision(player, object)) {
                                collisions++;
                            }
                        });
                        
                        if (collisions > 0) {
                            player.xpos++;
                            break;
                        } else {
                            $("#box")[0].style.left = player.xpos + "px";
                        }
                        
                        //update debug menu
                        updateDebug();
                    }
                }
                
                //vertical movement
                for (i = 0; i < Math.abs(player.yspeed); i++) {
                    if (player.yspeed > 0) {
                        
                        var collisions = 0;
                        player.ypos++;
                        
                        var returnedObjects = objects.filter(   function(obj) {
                                                                return  obj.ypos < player.ypos + player.yBox;
                                                            });
                        //array of all objects with y values that could potentially collide
                        returnedObjects.forEach(function(object) {
                            if (!checkCollision(player, object)) {
                                collisions++;
                            }
                        });
                        
                        if (collisions > 0) {
                            player.ypos--;
                            break;
                        } else {
                            $("#box")[0].style.bottom = player.ypos + "px";
                        }
                        
                        //update debug menu
                        updateDebug();
                    } else if (player.yspeed < 0) {
                        
                        var collisions = 0;
                        player.ypos--;
                        
                        var returnedObjects = objects.filter(   function(obj) {
                                                                return  obj.ypos+obj.yBox > player.ypos;
                                                            });
                        //array of all objects with y values that could potentially collide
                        returnedObjects.forEach(function(object) {
                            if (!checkCollision(player, object)) {
                                collisions++;
                            }
                        });
                        
                        if (collisions > 0) {
                            player.ypos++;
                            break;
                        } else {
                            $("#box")[0].style.bottom = player.ypos + "px";
                        }
                        
                        //update debug menu
                        updateDebug();
                    }
                }
                
                //animation of player
                
                //jump
                if (player.yspeed > 0) {
                    player.animFrame = 0;
                    $("#box")[0].style.backgroundPosition = "-423px -95px";
                }
                //falling
                else if (player.yspeed < 0) {
                    player.animFrame = 0;
                    $("#box")[0].style.backgroundPosition = "-423px 0px";
                }
                //standing
                else if (player.yspeed == 0 && player.xspeed == 0) {
                    player.animFrame = 0;
                    $("#box")[0].style.backgroundPosition = "-67px -190px";
                }
                //run
                else if (Math.abs(player.xspeed) > 0) {
                    if (player.animFrame == 30) {
                        player.animFrame = 0;
                        $("#box")[0].style.background = "url('images/p2_spritesheet.png') 0 0;";
                    }
                    else {
                        player.animFrame++;
                        $("#box")[0].style.backgroundPosition = "-" + player.walk[Math.floor(player.animFrame/3)][0] + "px -" + player.walk[Math.floor(player.animFrame/3)][1] + "px";
                    }
                }
            }, 17);
        </script>
    </body>
</html>